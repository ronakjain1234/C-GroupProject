@page "/user-management"
@using MudBlazor
@using DatabaseHandler.Data.Models.Web.ResponseObjects
@using System.Collections.Generic
@using System.Linq
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Net.Http.Json
@inject ISnackbar Snackbar
@inject HttpClient Http

<MudContainer>
    <MudText Typo="Typo.h4" Class="mb-4 mt-12">User Management</MudText>

    <MudPaper Class="pa-4">
        <MudTable T="GetAllCompaniesResponse" Items="@_companies" Dense="true" Hover="true"
                  HeaderClass="mud-theme-primary">
            <HeaderContent>
                <MudTh>Company Name</MudTh>
                <MudTh>Selected Users</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Company Name">
                    <MudButton Color="Color.Primary" OnClick="@(() => OpenUserDialog(@context.companyName))">
                        @context.companyName
                    </MudButton>
                </MudTd>
                <MudTd DataLabel="Selected Users">
                    @{
                        var selectedUsers = GetSelectedUsers(@context.companyName);
                        @foreach (var user in selectedUsers)
                        {
                            <MudChip T="string" Size="Size.Small" Class="ma-1">@user</MudChip>
                        }
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
</MudContainer>

<MudOverlay @bind-Visible="_isUserDialogVisible" DarkBackground="true">
    <MudPaper Class="pa-6" Style="max-width: 1200px; margin: 32px auto;">
        <MudText Typo="Typo.h5" Class="mb-4">Manage Users for Selected Bank</MudText>

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Elevation="0" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">Selected Users</MudText>
                    @foreach (var bank in _selectedBanks)
                    {
                        <MudExpansionPanel Text="@bank" Class="mb-2">
                            <MudList T="string" Dense="true" Clickable="true">
                                @foreach (var user in GetSelectedUsers(bank))
                                {
                                    <MudListItem T="string">
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
                                            <MudText>@user</MudText>
                                            <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                           Size="Size.Small"
                                                           OnClick="@(() => RemoveUser(bank, user))"
                                                           Class="ml-auto" />
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudExpansionPanel>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Elevation="0" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-4">Available Users</MudText>
                    @foreach (var userType in _userTypes)
                    {
                        <MudExpansionPanel Text="@userType" Icon="@GetUserTypeIcon(userType)" Class="mb-2">
                            <MudList T="string" Dense="true" Clickable="true">
                                @foreach (var user in GetAvailableUsers(userType))
                                {
                                    <MudListItem T="string">
                                        <div class="d-flex align-center">
                                            <MudText>@user</MudText>
                                            <MudSpacer />
                                            @foreach (var bank in _selectedBanks)
                                            {
                                                <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                               Size="Size.Small"
                                                               OnClick="@(() => AddUser(bank, user))"
                                                               Class="ml-2" />
                                            }
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudExpansionPanel>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudDivider DividerType="DividerType.Middle" Class="my-6" />

        <div class="d-flex justify-end gap-2">
            <MudButton Color="Color.Error"
                       Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Close"
                       OnClick="CloseUserDialog">Cancel</MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Save"
                       OnClick="SaveChanges">Save Changes</MudButton>
        </div>
    </MudPaper>
</MudOverlay>

@code {
    private HashSet<string> _selectedBanks = new();
    private bool _isUserDialogVisible;

    private List<GetAllCompaniesResponse> _companies = new();
    private List<string> _userTypes = new();
    private Dictionary<string, HashSet<string>> _selectedUsersByBank = new();
    private Dictionary<string, List<string>> _allUsersByType = new();

    // You can set this to the actual logged-in user's ID
    private int _currentUserId = 1; // Default to user ID 1 for testing

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
        await LoadRoles();
        await LoadAllUsers();
        await LoadUsers();
    }

    private async Task LoadCompanies()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<GetAllCompaniesResponse>>($"/api/company/get?userID={_currentUserId}");
            _companies = response ?? new List<GetAllCompaniesResponse>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading companies: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadRoles()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<GetRolesInCompanyResponse>($"/api/company/getRolesInCompany?companyId=1&userID={_currentUserId}");
            _userTypes = response?.roles.Select(r => r.Name).ToList() ?? new List<string>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading roles: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAllUsers()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<User>>("/api/user/get");
            if (response != null)
            {
                _allUsersByType = response
                    .GroupBy(u => GetUserType(u)) // You'll need to implement GetUserType
                    .ToDictionary(
                        g => g.Key,
                        g => g.Select(u => u.Name).ToList()
                    );
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading all users: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadUsers()
    {
        foreach (var company in _companies)
        {
            try
            {
                var response = await Http.GetFromJsonAsync<GetDetailedCompanyInfo>($"/api/company/getInfo?userID={_currentUserId}&companyId={company.companyId}");
                if (response != null)
                {
                    _selectedUsersByBank[company.companyName] = new HashSet<string>(
                        response.userInformation.Select(u => u.Name)
                    );
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading users for {company.companyName}: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task AddUser(string bank, string user)
    {
        var company = _companies.FirstOrDefault(c => c.companyName == bank);
        if (company != null)
        {
            try
            {
                var response = await Http.PostAsync($"/api/company/addUser?mainUserID={_currentUserId}&email={user}&companyId={company.companyId}", null);
                if (response.IsSuccessStatusCode)
                {
                    // Update local state
                    if (!_selectedUsersByBank.ContainsKey(bank))
                    {
                        _selectedUsersByBank[bank] = new HashSet<string>();
                    }
                    _selectedUsersByBank[bank].Add(user);
                    Snackbar.Add($"Added {user} to {bank}", Severity.Success);

                    // Refresh data from database
                    await LoadUsers();
                }
                else
                {
                    Snackbar.Add($"Failed to add user: {response.StatusCode}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task RemoveUser(string bank, string user)
    {
        var company = _companies.FirstOrDefault(c => c.companyName == bank);
        if (company != null)
        {
            try
            {
                var response = await Http.DeleteAsync($"/api/company/removeUser?mainUserID={_currentUserId}&userID=1&companyId={company.companyId}");
                if (response.IsSuccessStatusCode)
                {
                    if (_selectedUsersByBank.ContainsKey(bank))
                    {
                        _selectedUsersByBank[bank].Remove(user);
                        Snackbar.Add($"Removed {user} from {bank}", Severity.Info);
                    }
                }
                else
                {
                    Snackbar.Add($"Failed to remove user: {response.StatusCode}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error removing user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CloseUserDialog()
    {
        _isUserDialogVisible = false;
        Snackbar.Add("Changes discarded", Severity.Info);
        await Task.CompletedTask;
    }

    private async Task SaveChanges()
    {
        Snackbar.Add("Changes saved successfully", Severity.Success);
        CloseUserDialog();
        await Task.CompletedTask;
    }

    private void OpenUserDialog(string companyName)
    {
        _selectedBanks.Clear();
        _selectedBanks.Add(companyName);
        _isUserDialogVisible = true;
    }

    private string GetUserTypeIcon(string userType) => userType switch
    {
        "Intern" => Icons.Material.Filled.School,
        "Contractor" => Icons.Material.Filled.Work,
        _ => Icons.Material.Filled.Person
    };

    private List<string> GetSelectedUsers(string bank) =>
        _selectedUsersByBank.TryGetValue(bank, out var users)
            ? users.ToList()
            : new List<string>();

    private List<string> GetAvailableUsers(string userType)
    {
        if (!_allUsersByType.TryGetValue(userType, out var allUsers))
            return new List<string>();

        var allSelectedUsers = _selectedBanks
            .SelectMany(bank => _selectedUsersByBank.GetValueOrDefault(bank, new HashSet<string>()))
            .ToHashSet();

        return allUsers.Where(u => !allSelectedUsers.Contains(u)).ToList();
    }

    // Helper method to determine user type (we'll need to implement this based on our logic)
    private string GetUserType(User user)
    {
        // This is a placeholder - we need to implement with logic to determine user type
        return "Contractor"; // or "Intern" based on logic
    }
}

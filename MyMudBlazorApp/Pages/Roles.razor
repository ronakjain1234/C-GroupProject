@page "/company/{companyId:int}/roles"

@using MudBlazor
@using MyMudBlazorApp.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Net.Http.Json
@using Web = DatabaseHandler.Data.Models.Web.ResponseObjects;
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject NavigationManager Navigation


<style>
/* Your existing styles remain the same */
.mud-table th, .mud-table td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 8px 16px;
    vertical-align: middle;
}

.rolesTable {
    /* Remove max-height to prevent inner scrolling */
    width: 100%; /* Use full width of container */
    margin: 0 auto;
}

.search-field {
    margin-left: 16px;
}

.role-name-cell {
    min-width: 720px;
}

.actions-cell {
    display: flex;
    gap: 8px;
    align-items: center;
}

.page-title {
    margin-bottom: 16px;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
}

.endpoint-table {
    margin-top: 0;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    max-height: fit-content;
}

.endpoint-paper {
    background-color: #fafafa;
    padding: 8px;
    margin-bottom: 0;
}

.module-title {
    font-weight: 500;
    margin-bottom: 16px;
}

/* Styling for tabs */
.mud-tabs-panels {
    padding: 0 !important;
}

.mud-tab-slider {
    background-color: var(--mud-palette-primary);
}

.swipeable-tabs .mud-tabs-toolbar {
    justify-content: center;
}

.swipeable-tabs .mud-tabs-panels {
    min-height: 0;
    padding: 0 !important;
}

.compact-dialog {
    width: 700px;
    max-width: 90vw;
    max-height: 80vh;
}

/* Styling for main content tabs */
.main-tabs {
    margin-top: 16px;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
}

.main-tabs .mud-tabs-panels {
    min-height: 500px; /* Set consistent height for all tab panels */
    overflow-y: auto; /* Add scrolling to the tab panels instead of tables */
}

.empty-selection {
    padding: 32px;
    text-align: center;
    color: var(--mud-palette-text-secondary);
}

.entirePage {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.tab-content-container {
    width: 100%;
    height: 100%;
}

.endpoint-selection-container {
    width: 100%;
    height: 100%;
    overflow-y: auto;
}

.companySideBar {
    width: 64px;
    height: calc(100vh - 64px);
    position: fixed;
    left: 0;
    top: 64px;
    padding: 16px 8px;
    background-color: #f0f0f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    z-index: 1;
}

.mainContent {
    margin-left: 80px;
    padding: 20px;
    padding-top: 84px;
}

.entirePage {
    background-color: white;
    min-height: 100vh;
    padding: 20px;
}
</style>

<div class="companySideBar">
    <div class="sideBarButtons">
        <MudTooltip Text="Back" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo($"/company/{CompanyId}"))" />
        </MudTooltip>
        <MudTooltip Text="Add Role" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.PersonAdd"
                           Color="Color.Primary"
                           OnClick="AddRole"/>
        </MudTooltip>

    </div>
</div>

<div class="entirePage">
    <div class="mainContent">
        <div class="d-flex align-center mb-10" style="gap: 10px;">
            <MudText Typo="Typo.h3" Style="color: black;">Roles</MudText>

        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-center mt-6">
            <MudProgressCircular Color="Color.Primary" Size="Size.Medium" Indeterminate="true" />
        </div>
    }
    else
    {
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3" Class="main-tabs swipeable-tabs" Centered="true">
            <MudTabPanel Text="Roles Management">
                <div class="tab-content-container">
                    <MudTable class="rolesTable" Items="@RolesList" Filter="new Func<Web.Role, bool>(FilterFunc1)" MultiSelection="true"
                              @bind-SelectedItems="_selectedItems" Hover="true" FixedHeader="true">
                        <ToolBarContent>
                            <MudTextField @bind-Value="searchString1" 
                                        Placeholder="Search roles" 
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Search" 
                                        IconSize="Size.Medium" 
                                        Class="mt-0 mb-4 search-field"
                                        Immediate="true"
                                        DebounceInterval="300"></MudTextField>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh Style="width: 50px;">
                                <MudTableHeaderCheckbox T="Web.Role" />
                            </MudTh>
                            <MudTh Class="role-name-cell">Role Name</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd Style="width: 50px;">
                                <MudTableCheckbox T="Web.Role" Value="context" />
                            </MudTd>
                            <MudTd DataLabel="Role Name" Class="role-name-cell">
                                <MudTextField Value="@context.roleName" ReadOnly="false" Class="mt-0 mb-0" />
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                                    <MudButton StartIcon="@Icons.Material.Filled.Add" 
                                              OnClick="() => AddEndpoint(context.roleName)"
                                              Size="Size.Small">Add Group</MudButton>
                                    <MudButton StartIcon="@Icons.Material.Filled.ContentCopy" 
                                              OnClick="() => CloneRole(context.roleName)"
                                              Size="Size.Small">Clone</MudButton>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                 Color="Color.Error"
                                                 Size="Size.Small"
                                                 OnClick="() => RemoveRole(context.roleName)" />
                                </MudButtonGroup>
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <div class="d-flex align-center">
                                <MudTablePager />
                                <MudSpacer />
                                <MudButton Color="Color.Primary" 
                                          Variant="Variant.Outlined"
                                          StartIcon="@Icons.Material.Filled.Settings"
                                          OnClick="MakeChoicesForSelectedRoles"
                                          Disabled="@(!_selectedItems.Any())"
                                          Size="Size.Small"
                                          Class="ml-4">Make Choices</MudButton>
                            </div>
                        </PagerContent>
                    </MudTable>
                </div>
            </MudTabPanel>
            
            <MudTabPanel Text="Selected Endpoints">
                <div class="tab-content-container">
                    @if (!_roleEndpoints.Any())
                    {
                        <div class="empty-selection">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Large" Class="mb-2" />
                            <MudText Typo="Typo.h6">No endpoint selections available</MudText>
                            <MudText Typo="Typo.body2" Class="mt-2">
                                Select a role and click "Add Group" to assign endpoints.
                            </MudText>
                        </div>
                    }
                    else
                    {
                        <div class="endpoint-selection-container">
                            @foreach (var roleEndpoints in _roleEndpoints)
                            {
                                <MudPaper Elevation="2" Class="pa-4 mt-4">
                                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mb-2">
                                        Selected Endpoints for Role: @roleEndpoints.Key
                                    </MudText>
                                    <MudTable Items="@roleEndpoints.Value" Dense="true" Hover="false" ReadOnly="true" FixedHeader="true">
                                        <ColGroup>
                                            <col style="width: 50px;" />
                                            <col />
                                        </ColGroup>
                                        <RowTemplate>
                                            <MudTd>
                                                <MudIcon Icon="@Icons.Material.Filled.Link" />
                                            </MudTd>
                                            <MudTd DataLabel="Endpoint">@context</MudTd>
                                        </RowTemplate>
                                        <NoRecordsContent>
                                            <div class="empty-selection">
                                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Medium" Class="mb-2" />
                                                <MudText Typo="Typo.body1">No endpoints assigned to this role</MudText>
                                            </div>
                                        </NoRecordsContent>
                                    </MudTable>
                                </MudPaper>
                            }
                        </div>
                    }
                </div>
            </MudTabPanel>
        </MudTabs>
    }
</div>


@if (_isAddRoleOpen)
{
    <MudOverlay Visible="_isAddRoleOpen" DarkBackground="true" AutoClose="false">
        <MudPaper Elevation="24" Class="pa-4 compact-dialog">
            <div class="d-flex justify-space-between align-center mb-2">
                <div>
                    <MudText Typo="Typo.h5">Add New Role</MudText>
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary">Company: @_companyName</MudText>
                </div>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="CloseAddRoleDialog" />
            </div>
            
            <MudPaper Elevation="0" Class="pa-4">
                <MudTextField @bind-Value="_newRoleName"
                            Label="Role Name"
                            Variant="Variant.Outlined"
                            FullWidth="true"
                            Class="mt-4"
                            Immediate="true"
                            Validation="@(new Func<string, IEnumerable<string>>(ValidateRoleName))" />
            </MudPaper>

            <MudDivider DividerType="DividerType.Middle" Class="my-3"/>

            <div class="d-flex justify-end gap-2">
                <MudButton Color="Color.Error" 
                          Variant="Variant.Filled" 
                          StartIcon="@Icons.Material.Filled.Close" 
                          OnClick="CloseAddRoleDialog">Cancel</MudButton>
                      
                <MudButton Color="Color.Primary" 
                          Variant="Variant.Filled" 
                          StartIcon="@Icons.Material.Filled.PersonAdd" 
                          OnClick="@(() => CreateRole(_newRoleName))"
                          Disabled="@(string.IsNullOrWhiteSpace(_newRoleName))">Add Role</MudButton>
            </div>
        </MudPaper>
    </MudOverlay>
}

@if (_isOpen)
{
    <MudOverlay Visible="_isOpen" DarkBackground="true" AutoClose="false">
        <MudPaper Elevation="24" Class="pa-4 compact-dialog">
            <div class="d-flex justify-space-between align-center mb-2">
                <div>
                    <MudText Typo="Typo.h5">Endpoint Management</MudText>
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary">Role: @_currentRole</MudText>
                </div>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="CloseDialog" />
            </div>
            
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0" Class="swipeable-tabs" Centered="true">
                <MudTabPanel Text="Module ESMA" Style="padding: 0">
                    <MudPaper Elevation="0" Class="endpoint-paper">
                        <MudTable Items="@EsmaEndpoints" Dense="true" Hover="true" Class="endpoint-table"
                                 Elevation="0" Style="background-color: white;" MultiSelection="true"
                                 @bind-SelectedItems="_selectedEsmaEndpoints">
                            <HeaderContent>
                                <MudTh Style="width: 80px;">
                                    <MudTableHeaderCheckbox T="Endpoint" />
                                </MudTh>
                                <MudTh>Name</MudTh>
                                <MudTh>Description</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd Style="width: 80px;">
                                    <MudTableCheckbox T="Endpoint" Value="context" />
                                </MudTd>
                                <MudTd>@context.Name</MudTd>
                                <MudTd>@context.Description</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                </MudTabPanel>
                
                <MudTabPanel Text="Module Calculations" Style="padding: 0">
                    <MudPaper Elevation="0" Class="endpoint-paper">
                        <MudTable Items="@CalculationEndpoints" Dense="true" Hover="true" Class="endpoint-table"
                                 Elevation="0" Style="background-color: white;" MultiSelection="true"
                                 @bind-SelectedItems="_selectedCalculationEndpoints">
                            <HeaderContent>
                                <MudTh Style="width: 80px;">
                                    <MudTableHeaderCheckbox T="Endpoint" />
                                </MudTh>
                                <MudTh>Name</MudTh>
                                <MudTh>Description</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd Style="width: 80px;">
                                    <MudTableCheckbox T="Endpoint" Value="context" />
                                </MudTd>
                                <MudTd>@context.Name</MudTd>
                                <MudTd>@context.Description</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                </MudTabPanel>
            </MudTabs>

            <MudDivider DividerType="DividerType.Middle" Class="my-3"/>

            <div class="d-flex justify-end gap-2">
                <MudButton Color="Color.Error" 
                          Variant="Variant.Filled" 
                          StartIcon="@Icons.Material.Filled.Close" 
                          OnClick="CloseDialog">Close</MudButton>
                      
                <MudButton Color="Color.Primary" 
                          Variant="Variant.Filled" 
                          StartIcon="@Icons.Material.Filled.Save" 
                          OnClick="SaveAndClose"
                          Disabled="@(!HasSelectedEndpoints())">Save Selection</MudButton>
            </div>
        </MudPaper>
    </MudOverlay>
}

@code {
    [Parameter]
    public int CompanyId { get; set; }
    private bool _isAddRoleOpen;
    private string _newRoleName = string.Empty;
    private string _companyName = string.Empty;

    private int currentUserID = 1; // You might get this from auth state
    private string searchString1 = "";
    private bool _isOpen;
    private string _currentRole = "";
    private Dictionary<string, HashSet<string>> _roleEndpoints = new();
    private List<Web.Role> RolesList = new List<Web.Role>();
    private HashSet<Web.Role> _selectedItems = new HashSet<Web.Role>();
    private HashSet<Endpoint> _selectedEsmaEndpoints = new();
    private HashSet<Endpoint> _selectedCalculationEndpoints = new();
    private bool isLoading = true;

    public class Endpoint
    {
        public string Name { get; set; }
        public string Description { get; set; }
        public string Module { get; set; }
        public string Path { get; set; }
        public string Method { get; set; }
        public bool IsActive { get; set; }
    }

    private List<Endpoint> EsmaEndpoints = new()
    {
        new Endpoint { 
            Name = "Test ESMA Endpoint 1",
            Description = "Retrieves ESMA financial data",
            Module = "ESMA",
            Path = "/api/esma/financial-data",
            Method = "GET",
            IsActive = true
        },
        new Endpoint { 
            Name = "Test ESMA Endpoint 2",
            Description = "Updates ESMA market statistics",
            Module = "ESMA",
            Path = "/api/esma/market-stats",
            Method = "POST",
            IsActive = true
        },
        new Endpoint { 
            Name = "Test ESMA Endpoint 3",
            Description = "Fetches ESMA regulatory reports",
            Module = "ESMA",
            Path = "/api/esma/regulatory-reports",
            Method = "GET",
            IsActive = true
        }
    };

    private List<Endpoint> CalculationEndpoints = new()
    {
        new Endpoint { 
            Name = "Test Calculation Endpoint 1",
            Description = "Performs risk assessment calculations",
            Module = "Calculations",
            Path = "/api/calc/risk-assessment",
            Method = "POST",
            IsActive = true
        },
        new Endpoint { 
            Name = "Test Calculation Endpoint 2",
            Description = "Calculates market volatility metrics",
            Module = "Calculations",
            Path = "/api/calc/volatility",
            Method = "GET",
            IsActive = true
        },
        new Endpoint { 
            Name = "Test Calculation Endpoint 3",
            Description = "Generates performance analytics",
            Module = "Calculations",
            Path = "/api/calc/performance",
            Method = "GET",
            IsActive = true
        }
    };

    private IEnumerable<Endpoint> AllEndpoints => EsmaEndpoints.Concat(CalculationEndpoints);

    protected override async Task OnInitializedAsync()
    {
        ConfigureSnackbar();
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        try
        {
            isLoading = true;
            var result = await Http.GetFromJsonAsync<Web.GetRolesInCompanyResponse>($"api/company/getRolesInCompany?companyID={CompanyId}&userID={currentUserID}");
            
            if (result != null)
            {
                RolesList = result.roles;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading roles: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ConfigureSnackbar()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        Snackbar.Configuration.SnackbarVariant = Variant.Filled;
        Snackbar.Configuration.ShowTransitionDuration = 200;
        Snackbar.Configuration.HideTransitionDuration = 200;
        Snackbar.Configuration.VisibleStateDuration = 2000;
    }

    private void OpenAddRoleDialog()
    {
        _newRoleName = string.Empty;
        _isAddRoleOpen = true;
        StateHasChanged();
    }

    private void CloseAddRoleDialog()
    {
        _isAddRoleOpen = false;
        _newRoleName = string.Empty;
        StateHasChanged();
    }

    private IEnumerable<string> ValidateRoleName(string roleName)
    {
        if (string.IsNullOrWhiteSpace(roleName))
            yield return "Role name is required";
    }

    private async Task AddRole()
    {
        OpenAddRoleDialog();
    }

    private async Task RemoveRole(string roleName)
    {
        var role = RolesList.FirstOrDefault(r => r.roleName == roleName);
        if (role != null)
        {
            RolesList.Remove(role);
            _roleEndpoints.Remove(roleName);
            StateHasChanged();
        }
    }

    private async Task CloneRole(string roleName)
    {
        var newRoleName = $"{roleName}_Copy";
        var roleToClone = RolesList.FirstOrDefault(r => r.roleName == roleName);
        
        if (roleToClone != null)
        {
            var newRoleId = RolesList.Count > 0 ? RolesList.Max(r => r.roleID) + 1 : 1;
            var newRole = new Web.Role(newRoleId, newRoleName);
            RolesList.Add(newRole);
            
            if (_roleEndpoints.ContainsKey(roleName))
            {
                _roleEndpoints[newRoleName] = new HashSet<string>(_roleEndpoints[roleName]);
            }
            
            StateHasChanged();
        }
    }

    private bool FilterFunc1(Web.Role role) => 
        string.IsNullOrWhiteSpace(searchString1) || 
        role.roleName.Contains(searchString1, StringComparison.OrdinalIgnoreCase);

    private void OpenDialog() => _isOpen = true;
    private void CloseDialog() => _isOpen = false;

    private void AddEndpoint(string role) => OpenEndpointDialog(new[] { role });
    private void MakeChoicesForSelectedRoles() => OpenEndpointDialog(_selectedItems.Select(r => r.roleName));

    private void OpenEndpointDialog(IEnumerable<string> roles)
    {
        if (!roles.Any()) return;

        _currentRole = string.Join(", ", roles);
        _selectedEsmaEndpoints.Clear();
        _selectedCalculationEndpoints.Clear();

        var commonEndpoints = GetCommonEndpoints(roles);
        
        PreSelectEndpoints(commonEndpoints);
        
        OpenDialog();
    }

    private HashSet<string> GetCommonEndpoints(IEnumerable<string> roles)
    {
        var rolesList = roles.ToList();
        if (!rolesList.Any()) return new HashSet<string>();

      
        var commonEndpoints = _roleEndpoints.TryGetValue(rolesList[0], out var firstRoleEndpoints)
            ? new HashSet<string>(firstRoleEndpoints)
            : new HashSet<string>();

        
        foreach (var role in rolesList.Skip(1))
        {
            if (_roleEndpoints.TryGetValue(role, out var roleEndpoints))
            {
                commonEndpoints.IntersectWith(roleEndpoints);
            }
            else
            {
                commonEndpoints.Clear();
                break;
            }
        }

        return commonEndpoints;
    }

    private void PreSelectEndpoints(HashSet<string> endpointNames)
    {
        if (endpointNames == null || !endpointNames.Any()) return;

        _selectedEsmaEndpoints = new HashSet<Endpoint>(
            EsmaEndpoints.Where(e => endpointNames.Contains(e.Name))
        );

        _selectedCalculationEndpoints = new HashSet<Endpoint>(
            CalculationEndpoints.Where(e => endpointNames.Contains(e.Name))
        );
    }

    private bool HasSelectedEndpoints() => 
        _selectedEsmaEndpoints.Any() || _selectedCalculationEndpoints.Any();

    private void SaveAndClose()
    {
        SaveSelection();
        CloseDialog();
    }

    private void SaveSelection()
    {
        var selectedEndpoints = _selectedEsmaEndpoints
            .Concat(_selectedCalculationEndpoints)
            .Select(e => e.Name)
            .ToHashSet();

        if (selectedEndpoints.Any())
        {
            foreach (var role in _currentRole.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
            {
                _roleEndpoints[role] = selectedEndpoints;
            }
            ShowSuccessMessage();
        }
        else
        {
            foreach (var role in _currentRole.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
            {
                _roleEndpoints.Remove(role);
            }
            ShowWarningMessage();
        }
    }
    

    private async Task CreateRole(string roleName)
    {
        if (string.IsNullOrWhiteSpace(roleName))
        {
            Snackbar.Add("Role name cannot be empty.", Severity.Warning);
            return;
        }

        try
        {
            var response = await Http.PostAsync($"/api/company/createRole?userID=1&companyID={CompanyId}&name={Uri.EscapeDataString(roleName)}", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Role '{roleName}' created successfully!", Severity.Success);
                CloseAddRoleDialog();
                await LoadRoles();
            }
            else
            {
                Snackbar.Add($"Failed to create role '{roleName}'", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating role: {ex.Message}", Severity.Error);
        }
    }

    private void SaveEndpointsToRoles(HashSet<string> endpoints)
    {
        foreach (var role in _selectedItems)
        {
            _roleEndpoints[role.roleName] = endpoints;
        }
    }

    private void RemoveEndpointsFromRoles()
    {
        foreach (var role in _selectedItems)
        {
            _roleEndpoints.Remove(role.roleName);
        }
    }

    private void ShowSuccessMessage() =>
        ShowSnackbar($"Endpoints saved successfully for roles: {_currentRole}!", Severity.Info);

    private void ShowWarningMessage() =>
        ShowSnackbar("Please select at least one endpoint", Severity.Warning);

    private void ShowSnackbar(string message, Severity severity)
    {
        Snackbar.Add(message, severity, config =>
        {
            config.ShowCloseIcon = true;
            config.Action = "Dismiss";
            config.ActionColor = Color.Surface;
        });
    }
}
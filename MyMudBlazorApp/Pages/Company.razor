@page "/company/{companyId:int}"
@using System.Net.Http.Json
@using Web = DatabaseHandler.Data.Models.Web.ResponseObjects;
@using DatabaseHandler.Data.Models.Web.ResponseObjects;
@using MyMudBlazorApp.Services
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject HttpClient Http



<PageTitle>@_company.companyName</PageTitle>

<style>
    .companySideBar {
        width: 64px;
        height: calc(100vh - 64px);
        position: fixed;
        left: 0;
        top: 64px;
        padding: 16px 8px;
        background-color: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        z-index: 1;
    }

    .mainContent {
        margin-left: 80px;
        padding: 20px;
        padding-top: 84px;
    }

    .entirePage {
        background-color: white;
        min-height: 100vh;
        padding: 20px;
    }

    .companyTable {
        background-color: white;
        border-radius: 8px;
    }

    .sideBarButtons {
        margin-top: 16px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }

    .deleteCompanyButton {
        margin-top: auto;
        margin-bottom: 16px;
    }

    .companyTitle {
        display: flex;
        align-items: center;
    }

        .companyTitle h1 {
            margin: 0;
            padding: 0;
        }

    .mud-table th, .mud-table td {
        width: 200px;
        min-width: 200px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<div class="companySideBar">
    <div class="sideBarButtons">
        <MudTooltip Text="Back" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo("/"))" />
        </MudTooltip>

        <MudTooltip Text="Add User" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.PersonAdd"
                           Color="Color.Primary"
                           OnClick="@(() => OpenAddUserDialog())" />
        </MudTooltip>

        <MudTooltip Text="Manage Roles" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.ManageAccounts"
                          Color="Color.Primary"
                          OnClick="@(() => Navigation.NavigateTo("http://localhost:5084/company/3/roles"))" />
        </MudTooltip>

        <MudTooltip Text="Bulk Manage Roles" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.GroupAdd"
                           Color="Color.Primary"
                           Disabled="@(!_selectedItems.Any())"
                           OnClick="@OpenBulkRolesDialog" />
        </MudTooltip>

        <MudTooltip Text="Delete Company" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Color="Color.Error"
                           aria-label="Delete Company"
                           Class="deleteCompanyButton"
                           OnClick="@(() => DeleteCompany())" />
        </MudTooltip>
    </div>
</div>

<div class="entirePage">
    <div class="mainContent">
        <div class="companyTitle mb-10">
            <div style="display: flex; align-items: center; gap: 10px;">
                <MudTextField @bind-Value="_company.companyName"
                              Placeholder="Company Name"
                              Disabled="@_isCompanyNameDisabled"
                              Class="mt-2"
                              Variant="Variant.Outlined"
                              Dense="true"
                              Style="max-width: 250px;" />

                <MudTooltip Text="@(_isCompanyNameDisabled ? "Edit Company" : "Cancel Edit")">
                    <MudIconButton Icon="@(_isCompanyNameDisabled ? Icons.Material.Filled.Edit : Icons.Material.Filled.Close)"
                                   Color="Color.Warning"
                                   aria-label="Toggle Edit Mode"
                                   OnClick="@ToggleEditMode" />
                </MudTooltip>

                <MudTooltip Text="Save Changes">
                    <MudIconButton Icon="@Icons.Material.Filled.Save"
                                   Color="Color.Success"
                                   Disabled="@_isCompanyNameDisabled"
                                   aria-label="Save Company Name"
                                   OnClick="@SaveCompanyName" />
                </MudTooltip>


            </div>
        </div>

        <MudTable class="companyTable" Items="@_company.users" Filter="new Func<Web.User, bool>(FilterFunc)" MultiSelection="true" SelectionChangeable="true" Hover="true"
                  @bind-SelectedItems="_selectedItems" SelectOnRowClick="false">
            <ToolBarContent>
                <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Roles</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="Name">@context.userName</MudTd>
                <MudTd DataLabel="Email">@context.email</MudTd>
                <MudTd DataLabel="Roles">@context.RolesToString()</MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" aria-label="Add Role" Size="Size.Medium"
                                   OnClick="@(() => AddRoleToUser(context, context.roles.FirstOrDefault()?.roleID ?? 7))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" aria-label="Remove Role" Size="Size.Medium"
                                   OnClick="@(() => RemoveRoleFromUser(context, context.roles.FirstOrDefault()?.roleID ?? 7))" />
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    </div>
</div>

<MudDialog @bind-IsVisible="addUserDialogVisible" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Add User to Company</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_newUserEmail"
                      Label="Email"
                      Variant="Variant.Outlined" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => addUserDialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   OnClick="@(() => CreateNewUser(_newUserEmail))">
            Add User
        </MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-IsVisible="bulkRolesDialogVisible" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Manage Roles for Selected Users (@_selectedItems.Count users)</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Class="mb-4">Selected users:</MudText>
        <MudPaper Class="pa-4 mb-4">
            @foreach (var user in _selectedItems)
            {
                <MudText>@($"{user.userName} ({user.email})")</MudText>
            }
        </MudPaper>
        
        <MudDivider Class="my-4"/>
        
        <MudStack Row="true" Class="mt-4">
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Success" 
                      OnClick="@(() => BulkAddRoleToUsers(8))"
                      StartIcon="@Icons.Material.Filled.Add">
                Add Role
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Error" 
                      OnClick="@(() => BulkRemoveRoleFromUsers(8))"
                      StartIcon="@Icons.Material.Filled.Remove">
                Remove Role
            </MudButton>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => bulkRolesDialogVisible = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private HashSet<Web.User> _selectedItems = new();
    private string _newUserName = string.Empty;
    private string _newUserEmail = string.Empty;
    private string _newCompanyName = string.Empty;
    private Web.CompanyInfoResponse _company = new() { companyName = "", users = new List<Web.User>() };
    private string searchString = "";
    private string _originalCompanyName = "";
    private List<string> _roles = new();
    private bool _isCompanyNameDisabled = true;
    private bool bulkRolesDialogVisible;
    private bool addUserDialogVisible;
    private DialogOptions dialogOptions = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

    private void OpenBulkRolesDialog()
    {
        if (_selectedItems.Any())
        {
            bulkRolesDialogVisible = true;
        }
    }

    private async Task BulkAddRoleToUsers(int roleId)
    {
        try
        {
            foreach (var user in _selectedItems)
            {
                await AddRoleToUser(user, roleId);
            }
            bulkRolesDialogVisible = false;
            await LoadCompanyData();
            Snackbar.Add($"Role added to {_selectedItems.Count} users successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding roles: {ex.Message}", Severity.Error);
        }
    }
    private async Task BulkRemoveRoleFromUsers(int roleId)
    {
        try
        {
            foreach (var user in _selectedItems)
            {
                await RemoveRoleFromUser(user, roleId);
            }
            bulkRolesDialogVisible = false;
            await LoadCompanyData();
            Snackbar.Add($"Role removed from {_selectedItems.Count} users successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing roles: {ex.Message}", Severity.Error);
        }
    }
    private void ToggleEditMode()
    {
        if (_isCompanyNameDisabled)
        {
            _originalCompanyName = _company.companyName;
            _isCompanyNameDisabled = false;
        }
        else
        {
            _company.companyName = _originalCompanyName;
            _isCompanyNameDisabled = true;
        }
    }

    private async Task SaveCompanyName()
    {
        _isCompanyNameDisabled = true;
        await ChangeCompanyName(_company.companyName);
    }

    [Parameter] public int CompanyId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<Web.CompanyInfoResponse>($"api/company/getCompany?userID=1&companyID=3");


            if (result != null)
            {
                _company = result;
                CompanyId = 3;
                _newCompanyName = _company.companyName ?? string.Empty;

                foreach (var user in result.users)
                {
                    var roles = string.Join(", ", user.roles.Select(r => r.roleName));
                    _roles.Add($"{user.userName}: {roles}"); 
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add("Failed to load company data", Severity.Error);
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private bool FilterFunc(Web.User user)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (user.userName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (user.email.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private async Task ChangeCompanyName(string companyName)
    {
        try
        {


            var url = $"/api/company/changeCompanyName?userID=1&companyID={CompanyId}&companyName={Uri.EscapeDataString(companyName)}";

            var response = await Http.PutAsync(url, null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Company name updated to '{companyName}' successfully!", Severity.Success);
                await LoadCompanyData();
            }
            else
            {
                Snackbar.Add($"Failed to update company name. Please try again later.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating company name: {ex.Message}", Severity.Error);
        }
    }


    private async Task CreateRole(string roleName)
    {
        if (string.IsNullOrWhiteSpace(roleName))
        {
            Snackbar.Add("Role name cannot be empty.", Severity.Warning);
            return;
        }

        try
        {
            var response = await Http.PostAsJsonAsync("/api/company/createRole?userID=1&companyID=3&name=admin", new { roleName });
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Role '{roleName}' created successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Failed to create role '{roleName}'", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating role: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddRoleToUser(User user, int roleId)
    {
        try
        {
            var response = await Http.PostAsync($"http://localhost:5000/api/company/addRoletoUser?mainUserID=1&userID=5&companyID=3&roleID=8", null);
            if (response.IsSuccessStatusCode)
            {
                var role = user.roles.FirstOrDefault(r => r.roleID == roleId);
                var roleName = role?.roleName ?? "Unknown Role";
                Snackbar.Add($"Role '{roleName}' added to user successfully!", Severity.Success);
                await LoadCompanyData();
            }
            else
            {
                Snackbar.Add($"Failed to add role to user", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding role to user: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveRoleFromUser(User user, int roleId)
    {
        try
        {
            var response = await Http.DeleteAsync($"http://localhost:5000/api/company/removeRoleFromUser?mainUserID=1&userID=5&companyID=3&roleID=8");
            if (response.IsSuccessStatusCode)
            {
                var role = user.roles.FirstOrDefault(r => r.roleID == roleId);
                var roleName = role?.roleName ?? "Unknown Role";
                Snackbar.Add($"Role '{roleName}' removed from user successfully!", Severity.Success);
                await LoadCompanyData();
            }
            else
            {
                Snackbar.Add($"Failed to remove role from user", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing role from user: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveUserFromCompany(User user)
    {
        try
        {
            var response = await Http.DeleteAsync($"/api/company/removeUser?mainUserID=1&userID=1&companyID={CompanyId}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("User removed successfully!", Severity.Success);
                await LoadCompanyData();
            }
            else
            {
                Snackbar.Add("Failed to remove user", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing user: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadCompanyData()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<Web.CompanyInfoResponse>($"api/company/getCompany?userID=1&companyID={CompanyId}");
            if (result != null)
            {
                _company = result;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading company data: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddUserToCompany(User user, string email)
    {
        try
        {
            var url = $"/api/company/addUser?mainUserID=1&email={Uri.EscapeDataString(email)}&companyID={CompanyId}";
            var response = await Http.PostAsJsonAsync(url, new { companyId = CompanyId, user = user });
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("User added successfully!", Severity.Success);
                await LoadCompanyData();
            }
            else
            {
                Snackbar.Add("Failed to add user", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding user: {ex.Message}", Severity.Error);
        }
    }
    private async Task CreateNewUser(string newUserEmail)
    {
        if (string.IsNullOrWhiteSpace(newUserEmail))
        {
            Snackbar.Add("Email is required.", Severity.Warning);
            return;
        }

        try
        {
            var addUserResponse = await Http.PostAsync(
                $"/api/company/addUser?mainUserID=1&email={Uri.EscapeDataString(newUserEmail)}&companyID=3", null);

            if (addUserResponse.IsSuccessStatusCode)
            {
                addUserDialogVisible = false;
                Snackbar.Add($"User added to the company successfully!", Severity.Success);
                await LoadCompanyData();
            }
            else
            {
                Snackbar.Add("Failed to add user to the company.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding user: {ex.Message}", Severity.Error);
        }
    }


    private async Task UpdateRole(string currentRole, string newRole)
    {
        try
        {
            var response = await Http.PutAsJsonAsync("/api/role/update", new { currentRole, newRole });
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Role updated from '{currentRole}' to '{newRole}' successfully!", Severity.Success);
                await LoadCompanyData();
            }
            else
            {
                Snackbar.Add($"Failed to update role from '{currentRole}' to '{newRole}'", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating role: {ex.Message}", Severity.Error);
        }
    }


    private async Task DeleteCompany()
    {
        try
        {
            var response = await Http.DeleteAsync($"/api/company/delete?companyId={CompanyId}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Company deleted successfully!", Severity.Success);
                Navigation.NavigateTo("/"); // Redirect after successful deletion
            }
            else
            {
                Snackbar.Add("Failed to delete company", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting company: {ex.Message}", Severity.Error);
        }
    }

    private void OpenAddUserDialog()
    {
        _newUserEmail = string.Empty;
        addUserDialogVisible = true;
    }

}

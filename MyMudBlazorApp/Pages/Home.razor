@page "/"
@using MudBlazor
@using DatabaseHandler.Data.Models.Web.ResponseObjects
@using MyMudBlazorApp.Services
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject HttpClient Http


<style>
    .companySideBar {
        width: 64px;
        height: calc(100vh - 64px);
        position: fixed;
        left: 0;
        top: 64px;
        padding: 16px 8px;
        background-color: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        z-index: 1;
    }

    .mainContent {
        margin-left: 80px;
        padding: 20px;
        padding-top: 84px;
    }

    .entirePage {
        background-color: white;
        min-height: 100vh;
        padding: 20px;
    }

    .page-title {
        margin-bottom: 16px;
    }
</style>

<div class="companySideBar">
    <div class="sideBarButtons">
        <MudTooltip Text="Back" Placement="Placement.Right">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo("/"))" />
        </MudTooltip>
    </div>
</div>

<div class="entirePage">
    <div class="mainContent">
        <div class="d-flex justify-space-between align-center mb-10 page-title">
            <MudText Typo="Typo.h3" Style="color: black;">Companies</MudText>
            <MudTextField @bind-Value="searchString" 
                        Placeholder="Search" 
                        Adornment="Adornment.Start" 
                        AdornmentIcon="@Icons.Material.Filled.Search" 
                        IconSize="Size.Medium" 
                        Class="mt-0"
                        Style="width: 200px; margin-left: auto;" />
        </div>

        <MudGrid Spacing="8">
            @foreach (var company in FilteredCompanies)
            {
                <MudItem xs="12" sm="6" lg="4" Class="mb-10">
                    <MudCard Elevation="2" Style="height: 100%;">
                        <MudCardContent Class="pa-7">
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.h6">@company.companyName</MudText>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigateToCompany(company.companyID))">View Details</MudButton>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <div class="pt-12 d-flex justify-center w-100 mb-10">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateCompanyDialog">
                Create Company
            </MudButton>
        </div>
    </div>
</div>

@if (_isCreateCompanyDialogOpen)
{
    <MudOverlay Visible="_isCreateCompanyDialogOpen" DarkBackground="true" AutoClose="false">
        <MudPaper Elevation="24" Class="pa-4 compact-dialog">
            <div class="d-flex justify-space-between align-center mb-2">
                <div>
                    <MudText Typo="Typo.h5">Add Company</MudText>
                </div>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="CloseCreateCompanyDialog" />
            </div>
        
            <MudPaper Elevation="0" Class="pa-4">
                <MudTextField @bind-Value="newCompanyName"
                            Label="Company Name"
                            Variant="Variant.Outlined"
                            FullWidth="true"
                            Class="mt-4"
                            Immediate="true"
                            Required="true"
                            RequiredError="Company name is required!"/>
            </MudPaper>

            <MudDivider DividerType="DividerType.Middle" Class="my-3"/>

            <div class="d-flex justify-end gap-2">
                <MudButton Color="Color.Error" 
                          Variant="Variant.Filled" 
                          StartIcon="@Icons.Material.Filled.Close" 
                          OnClick="CloseCreateCompanyDialog">Cancel</MudButton>
                  
                <MudButton Color="Color.Primary" 
                          Variant="Variant.Filled" 
                          StartIcon="@Icons.Material.Filled.Add" 
                          OnClick="CreateCompany">Create</MudButton>
            </div>
        </MudPaper>
    </MudOverlay>
}

@code {
    private List<GetAllCompaniesResponse> Companies { get; set; } = new();
    private string searchString = "";
    private bool _isCreateCompanyDialogOpen;
    private string newCompanyName = "";

    private List<GetAllCompaniesResponse> FilteredCompanies => 
        Companies.Where(c => FilterFunc(c)).ToList();

    private bool FilterFunc(GetAllCompaniesResponse company)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (company.companyName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
    }

    private async Task LoadCompanies()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<GetAllCompaniesResponse>>("/api/company/get?userID=1");
            if (result != null)
            {
                Companies = result;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add("Failed to load companies", Severity.Error);
        }
    }

    private void OpenCreateCompanyDialog()
    {
        _isCreateCompanyDialogOpen = true;
    }

    private void CloseCreateCompanyDialog()
    {
        _isCreateCompanyDialogOpen = false;
        newCompanyName = "";
    }

    private async Task CreateCompany()
    {
        if (string.IsNullOrWhiteSpace(newCompanyName))
        {
            Snackbar.Add("Please enter a company name", Severity.Warning);
            return;
        }

        try
        {
            var url = $"http://localhost:5000/api/company/createCompany?userID=1&companyName={Uri.EscapeDataString(newCompanyName)}";
            var response = await Http.PostAsync(url, null);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<CreateCompanyResponse>();
                if (result != null)
                {
                    Snackbar.Add("Company created successfully!", Severity.Success);
                    CloseCreateCompanyDialog();
                    await LoadCompanies();
                }
                else
                {
                    Snackbar.Add("Failed to parse response", Severity.Error);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {errorContent}");
                Snackbar.Add($"Failed to create company: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating company: {ex.Message}");
            Snackbar.Add($"Failed to create company: {ex.Message}", Severity.Error);
        }
    }

    private void NavigateToCompany(int companyID)
    {
        Navigation.NavigateTo($"/company/{companyID}");
    }
}